---
title: "R per proletari - Episodio 2"
subtitle: "Bollettino della qualità  dell'aria per il glorioso popolo lavoratore"
author: "Andrea Bazzano"
format:
  pdf:
    template: templates/soviet-template.tex
    latex-engine: xelatex
    number-sections: false
    fig-format: pdf
  html:
    description:
      - "Proletari della tastiera, liberatevi dal giogo del copia-incolla<br>"
      - "Respingete i fogli di calcolo borghesi!"
    theme: cosmo
    css: www/soviet-style.css
    embed-resources: true
    toc: false
    number-sections: false
    lightbox: true
lang: it
highlight: null
fontsize: 12pt
geometry: a4paper
execute: 
  echo: false
  warning: false
  error: false
project:
  output-dir: docs
---

```{r}
#| label: librerie

# carico le librerie necessarie per il progetto
library(data.table)
library(httr2)
library(ggplot2)

# carico script
source("R/utils.R")
source("R/data_download.R")
source("R/data_anagrafiche.R")
source("R/analisi_numerica.R")
source("R/analisi_grafica.R")
source("R/report_helper.R")
```

```{r}
#| label: variabili

# definisco alcune variabili globali utilizzate dal progetto
prov_sigla <- "RE"                                    # sigla di Reggio Emilia
data_selezionata <- "06/09/2025"                      # data scelta
dataset_id <- "4dc855a1-6298-4b71-a1ae-d80693d43dcb"  # ID della risorsa CKAN
limit <- 1000                                         # records per chiamata all'API
log_file <- "data/log_download.csv"                   # file di log
```


## Introduzione

Compagno, con questo report scritto con `R` e `Quarto`, scaricheremo ed elaboreremo i dati di qualità dell'aria forniti dai fratelli socialisti dell'Emilia-Romagna.

Nel documento `report.qmd` troverai sia passaggi di testo, sia blocchi di codice R racchiusi tra tripli backtick `` ``` ``` ``, sia frammenti di codice in linea delimitati da singoli backtick `` ` ` ``.  
Al termine della compilazione, otterrai report HTML e PDF completi, in cui testo e risultati di calcolo marceranno insieme: il giogo borghese di Excel è stato spezzato e la rivoluzione dei dati è iniziata!

## Materiali

I dati necessari vengono scaricati dall’*application programming interface* (API) del robusto database di [ARPA Emilia-Romagna](https://dati.arpae.it/api/3/action/datastore_search?resource_id=4dc855a1-6298-4b71-a1ae-d80693d43dcb&limit=5), grazie a funzioni appositamente forgiate e custodite nel file `R/data_download.R`.

In alternativa, è possibile caricare i dati anche da file `.csv` o `xlsx`: compagno, anche dai formati più borghesi può nascere un report degno della pianificazione quinquennale.

Dopo il download, i dati vengono ripuliti e integrati con le informazioni delle anagrafiche delle stazioni e dei parametri, ottenute direttamente dal Centro Dati del Popolo di [ARPA Emilia-Romagna](https://dati.arpae.it/dataset/qualita-dell-aria-rete-di-monitoraggio).

```{r}
#| label: carico_dati
#| message: false

# 1. Carico le anagrafiche e filtro per provincia
anagrafiche <- carica_anagrafiche(prov_sigla = prov_sigla)
provincia <- carica_provincia(sigla = prov_sigla)

# 2. Scarico i dati per quelle stazioni
dati_api <- scarica_dati_sql(
  dataset_id = "4dc855a1-6298-4b71-a1ae-d80693d43dcb",
  stazioni_selezionate = anagrafiche$stazioni_selezionate,
  data_selezionata = "06/09/2025"
)[]

# 3. Merge con anagrafiche
dati <- merge(
  dati_api,
  anagrafiche$anagrafica_stazioni,
  by.x = c("station_id", "variable_id"),
  by.y = c("cod_staz", "id_param")
)
# perdiamo per strada alcuni dati relativi a:
# ozono (O3) misurato presso la centralina S. Lazzaro
# o-xilene (C6H4(CH3)2) presso la centrlina Timavo,
# però non è colpa nostra: i compagni probabilmente non hanno aggiornati i file
# csv di appoggio.

```

Con le funzioni in `R/analisi_numerica.R` vengono svolte le analisi previste dal Decreto Legislativo 152/2010 prodotto dall'assemblea del popolo, sorvolando su qualche controllo borghese riguardante la numerosità dei valori: la rivoluzione non può aspettare!

In `R/analisi_grafica.R` i grafici si ergono come bandiere rosse al vento: approvati dal Komintern e benedetti dal compagno Lenin, pronti a diffondere tra le masse il glorioso progetto internazionale socialista.

Infine, in `R/report_helper.R` orchestra tabelle, grafici e commenti militanti con funzioni automatiche come `crea_sezione_parametro()`. Le frasi? Direttamente dal libretto rosso del compagno Mao, per un report che marcia compatto verso l'illuminazione proletaria.

```{r}
#| label: results
#| output: asis

cat(paste("\n\n## Risultati del", data_selezionata,
          "per la provincia di", provincia, "\n\n"))

report <- report_giornaliero(dati)
report_giornaliero_sezioni(report, dati)
```

```{=html}
<footer class="copyright">
  &copy; 2025 Andrea Bazzano — <a href="https://www.linkedin.com/in/andreabazzano/" target="_blank">LinkedIn</a> | <a href="https://github.com/andreabz" target="_blank">GitHub</a> — Licenza CC-SA
</footer>
```
